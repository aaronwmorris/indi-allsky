{% extends 'base.html' %}

{% block title %}{{ website_title }}: {{ page_title }}{% endblock %}

{% block head %}
<meta charset="UTF-8">
<style>
#wrapper {
    position: relative;
    display: inline-block;
}

#latest-image {
    max-width: 100%;
    max-height: 75vh;
    width: auto;
    height: auto;
    object-fit: contain;
}

#starmap_container {
    position: absolute;
    top: 0;
    left: 0;
    overflow: hidden;
    /* Debugging */
    /* border: 3px solid red; */
    /* box-sizing: border-box; */
}

#starmap {
    position: relative;
}
</style>
<script src="{{ url_for('indi_allsky.static', filename='virtualsky/stuquery.min.js') }}"></script>
<script src="{{ url_for('indi_allsky.static', filename='virtualsky/virtualsky.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('indi_allsky.static', filename='html2canvas/html2canvas.min.js') }}" type="text/javascript"></script>
<script type="text/javascript">
var img;
var json_data = {
    'image_list' : [],
    'message' : '',
};
var max_age = 900;
var camera_id = {{ camera_id }};
var refreshInterval = {{ refreshInterval | int }};
var timestamp = {{ timestamp | int }};  // does not really do anything yet
var night = {{ night }};
var fullscreen = false;  // initial state

var camera_latitude = {{ camera_latitude }};
var camera_longitude = {{ camera_longitude }};
var time_offset = {{ time_offset }};

var planetarium;
var redraw_planetarium = false;
var last_image_timestamp = 0;


function init() {
    console.log("Camera Latitude: " + camera_latitude);
    console.log("Camera Longitude: " + camera_longitude);
    //console.log("Camera Image Circle: " + camera_lensimagecircle);
    //console.log("Lens Offset X: " + camera_lens_offset_x);
    //console.log("Lens Offset Y: " + camera_lens_offset_y);


    // Azimuth manipulations
    //console.log("Camera Azimuth: " + camera_az);
    //console.log("Camera Altitude: " + camera_alt);


    // Calculate latitude and longitude offset
    /*
    if (camera_az < 90) {
        az_90 = camera_az % 90
    } else if (camera_az >= 90 && camera_az < 180) {
        az_90 = 90 - (camera_az % 90)
    } else if (camera_az >= 180 && camera_az < 270) {
        az_90 = camera_az % 90
    } else {
        az_90 = 90 - (camera_az % 90)
    }


    var a_adj = 100;  // fake adjacent leg of triangle, can be any value

    var a_opp = Math.tan(((90 - camera_alt) * Math.PI) / 180) * a_adj;

    var b_hyp_2 = a_opp;
    var lat_adj = Math.cos((az_90 * Math.PI) / 180) * b_hyp_2;

    var z_opp = lat_adj;
    var lat_deg_offset = Math.atan(z_opp / a_adj) * (180 / Math.PI);
    if (camera_az < 90 || camera_az > 270) {
        // relatively sure this is correct
        lat_deg_offset *= -1;
    }


    var long_adj = Math.cos(((90 - az_90) * Math.PI) / 180) * b_hyp_2;
    var z2_opp = long_adj;
    long_deg_offset = Math.atan(z2_opp / a_adj) * (180 / Math.PI);
    if (camera_az < 180) {
        // unsure which direction should add/subract
        // this may be backwards
        long_deg_offset *= -1;
    }


    console.log("Latitude Offset: " + lat_deg_offset);
    console.log("Longitude Offset: " + long_deg_offset);


    // Set form values
    $("#LATITUDE_OFFSET").val(lat_deg_offset.toFixed(2));
    $("#LONGITUDE_OFFSET").val(long_deg_offset.toFixed(2));
    */


    loadNextImage();
    loop();
}

async function loop() {
    //console.log('Starting loop');
    while(json_data['image_list'].length == 0) {
        await sleep(100);
    }

    var image_width = json_data['image_list'][0]['width'];
    var image_height = json_data['image_list'][0]['height'];
    var image_timestamp = json_data['image_list'][0]['timestamp'];

    img = new Image();
    img.onload = function() {
        $('#latest-image').attr({
            'src': this.src,
        });


        if (redraw_planetarium || image_timestamp != last_image_timestamp) {
            var magnitude = Number($("#MAGNITUDE").val());
            var constellations = $("#CONSTELLATIONS").prop('checked');
            var constellationlabels = $("#CONSTELLATIONLABELS").prop('checked');
            var showstars = $("#SHOWSTARS").prop('checked');
            var showstarlabels = $("#SHOWSTARLABELS").prop('checked');
            var showplanets = $("#SHOWPLANETS").prop('checked');
            var showplanetlabels = $("#SHOWPLANETLABELS").prop('checked');

            var azimuth_angle = Number($("#AZIMUTH_ANGLE").val());
            var latitude_offset = Number($("#LATITUDE_OFFSET").val());
            var longitude_offset = Number($("#LONGITUDE_OFFSET").val());
            var image_circle_diameter = Number($("#IMAGE_CIRCLE_DIAMETER").val());
            var offset_x = Number($("#OFFSET_X").val());
            var offset_y = Number($("#OFFSET_Y").val());

            var vs_latitude = camera_latitude + latitude_offset;
            var vs_longitude = camera_longitude + longitude_offset;

            console.log("Latitude (with offset): " + vs_latitude);
            console.log("Longitude (with offset): " + vs_longitude);


            // Get the rendered size of the image and save w/h
            const render_width = $('#latest-image').width();
            const render_height = $('#latest-image').height();

            const image_scale = render_width / image_width;

            // Determine offsets of the starmap overlay
            const bias_left = ((( image_circle_diameter * image_scale - render_width ) / 2) - ( offset_x * image_scale )) * -1;
            const bias_top = ((( image_circle_diameter * image_scale - render_height ) / 2) + ( offset_y * image_scale )) * -1;

            // Apply those dimensions to the starmap container
            $('#starmap_container').css({
                width: render_width + 'px',
                height: render_height  + 'px'
            });

            // Apply those dimensions to the starmap itself
            $('#starmap').css({
                left: bias_left + 'px',
                top: bias_top + 'px'
            });


            // VirtualSky reverses north/south for some reason
            var vs_az = 180 - azimuth_angle;

            // Make sure azimuth is between 0 and 360
            if (vs_az >= 360) {
                vs_az -= 360;
            } else if (vs_az < 0) {
                vs_az += 360;
            }


            // Most cameras are east/west reversed
            var vs_az = 360 - vs_az;
            console.log("Calculated VirtualSky Azimuth: " + vs_az);


            // Using image timestamp for planetarium
            var clock = new Date((image_timestamp - time_offset) * 1000);
            console.log("Time Offset: " + time_offset);
            console.log("Date: " + clock);


            planetarium = S.virtualsky({
                id: 'starmap',
                projection: 'fisheye',
                live: false,
                clock: clock,
                latitude: vs_latitude,
                longitude: vs_longitude,
                az: vs_az,
                magnitude: magnitude,
                constellations: constellations,
                constellationlabels: constellationlabels,
                showstars: showstars,
                showstarlabels: showstarlabels,
                showplanets: showplanets,
                showplanetlabels: showplanetlabels,
                showgalaxy: true,
                gridstep: 30,
                gridlines_eq: true,
                gridlines_az: false,
                gridlines_gal: false,
                ecliptic: false,
                meridian: false,
                mouse: false,
                keyboard: false,
                showdate: false,
                showposition: false,
                gradient: false,
                transparent: true,
                cardinalpoints: true,
                credit: false,
                /* force the star map size here by using the lensImageCircle
                and resizing based on the ratio of the actual image sized versus rendered size */
                width: image_circle_diameter * image_scale,
                height: image_circle_diameter * image_scale,
            });


            redraw_planetarium = false;

            // update timestamp
            last_image_timestamp = image_timestamp;
        }
    };


    showImage(json_data['image_list'][0]);

    setTimeout(loop, refreshInterval);
}


function showImage(entry) {
    console.log('Showing image ' + entry["url"]);
    img.src = entry["url"];
}


function loadNextImage() {
    console.log('Loading next image');
    loadJS("{{ url_for(image_loop_view) }}", {'camera_id' : camera_id, 'limit_s' : 900, 'timestamp' : timestamp}, function() {});
    setTimeout(loadNextImage, refreshInterval);
}

function sleep(time) {
    return new Promise(resolve => setTimeout(resolve, time));
}

function loadJS(url, data, onDone, onError) {
    if(!onDone)onDone=function(){};
    if(!onError)onError=function(){};

    $.ajax({
        type: "GET",
        url: url,
        contentType: "application/json",
        data: data,
        success: function(rdata){
            json_data = rdata
            $('#message').html(json_data['message']);

            redraw_planetarium = true;
        },
        error: function(rdata){
            onError(rdata.status);
            $('#message').html('Error loading data.  Please check the logs.');
        },
    });
}

</script>
{% endblock %}

{% block content %}
<div class="container h-100">
<form id="form_virtualsky" onSubmit="return false;">
    <div class="form-group row" style="font-size:12px">
        <div class="col-sm-1"></div>
        <div class="col-sm-1">
            {{ form_virtualsky.AZIMUTH_ANGLE.label(class='col-form-label') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.LATITUDE_OFFSET.label(class='col-form-label') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.LONGITUDE_OFFSET.label(class='col-form-label') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.IMAGE_CIRCLE_DIAMETER.label(class='col-form-label') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.OFFSET_X.label(class='col-form-label') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.OFFSET_Y.label(class='col-form-label') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.MAGNITUDE.label(class='col-form-label') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.CONSTELLATIONS.label(class='col-form-label') }}
            <div class="form-switch">
                {{ form_virtualsky.CONSTELLATIONS(class='form-check-input') }}
            </div>
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.SHOWSTARS.label(class='col-form-label') }}
            <div class="form-switch">
                {{ form_virtualsky.SHOWSTARS(class='form-check-input') }}
            </div>
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.SHOWPLANETS.label(class='col-form-label') }}
            <div class="form-switch">
                {{ form_virtualsky.SHOWPLANETS(class='form-check-input') }}
            </div>
        </div>

        <div class="col-sm-1">
            <div><a href="https://github.com/aaronwmorris/indi-allsky/wiki/VirtualSky" class="text-decoration-none link-info" target="_blank">VirtualSky Wiki</a></div>
        </div>
    </div>

    <div class="form-group row">
        <div class="col-sm-1"></div>
        <div class="col-sm-1">
            {{ form_virtualsky.AZIMUTH_ANGLE(class='form-control bg-secondary') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.LATITUDE_OFFSET(class='form-control bg-secondary') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.LONGITUDE_OFFSET(class='form-control bg-secondary') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.IMAGE_CIRCLE_DIAMETER(class='form-control bg-secondary') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.OFFSET_X(class='form-control bg-secondary') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.OFFSET_Y(class='form-control bg-secondary') }}
        </div>

        <div class="col-sm-1">
            {{ form_virtualsky.MAGNITUDE(class='form-control bg-secondary') }}
        </div>

        <div class="col-sm-1" style="font-size:12px">
            {{ form_virtualsky.CONSTELLATIONLABELS.label(class='col-form-label') }}
            <div class="form-switch">
                {{ form_virtualsky.CONSTELLATIONLABELS(class='form-check-input') }}
            </div>
        </div>

        <div class="col-sm-1" style="font-size:12px">
            {{ form_virtualsky.SHOWSTARLABELS.label(class='col-form-label') }}
            <div class="form-switch">
                {{ form_virtualsky.SHOWSTARLABELS(class='form-check-input') }}
            </div>
        </div>

        <div class="col-sm-1" style="font-size:12px">
            {{ form_virtualsky.SHOWPLANETLABELS.label(class='col-form-label') }}
            <div class="form-switch">
                {{ form_virtualsky.SHOWPLANETLABELS(class='form-check-input') }}
            </div>
        </div>
    </div>
</form>

    <hr>

    <div class="row">
        <div class="text-muted text-center" id="message">Loading...</div>
    </div>
    <div class="row align-items-center">
        <div class="col-12 text-center" style="font-size:10px">
            Latitude / Longitude / Azimuth / Image Circle / Offsets must be correctly configured under Config -> Location [tab]
        </div>
    </div>
    <div class="row align-items-center">
        <div class="col-12 text-center">
          <div id="wrapper">
            <img id="latest-image">
            <div id="starmap_container">
                <div id="starmap"></div>
            </div>
          </div>
        </div>
    </div>
    <div class="row align-items-center">
        <div class="col-12 text-center">
          <div style="margin-top: 20px;">
            <span id="download" class="badge pill bg-info text-dark" style="cursor: pointer;">Download</span>
          </div>
        </div>
    </div>
</div>

<script>
function forceRedrawPlanetarium() {
    if (json_data['image_list'].length > 0) {
        redraw_planetarium = true;

        showImage(json_data['image_list'][0]);
    };
}


$("#AZIMUTH_ANGLE").on("change", function() {
    forceRedrawPlanetarium();
});

$("#LATITUDE_OFFSET").on("change", function() {
    forceRedrawPlanetarium();
});

$("#LONGITUDE_OFFSET").on("change", function() {
    forceRedrawPlanetarium();
});

$("#IMAGE_CIRCLE_DIAMETER").on("change", function() {
    forceRedrawPlanetarium();
});

$("#OFFSET_X").on("change", function() {
    forceRedrawPlanetarium();
});

$("#OFFSET_Y").on("change", function() {
    forceRedrawPlanetarium();
});

$("#MAGNITUDE").on("change", function() {
    forceRedrawPlanetarium();
});

$("#CONSTELLATIONS").on("change", function() {
    forceRedrawPlanetarium();
});

$("#CONSTELLATIONLABELS").on("change", function() {
    forceRedrawPlanetarium();
});

$("#SHOWSTARS").on("change", function() {
    forceRedrawPlanetarium();
});

$("#SHOWSTARLABELS").on("change", function() {
    forceRedrawPlanetarium();
});

$("#SHOWPLANETS").on("change", function() {
    forceRedrawPlanetarium();
});

$("#SHOWPLANETLABELS").on("change", function() {
    forceRedrawPlanetarium();
});


function setResizeHandler(callback, timeout) {
    var timer_id = undefined;
    $(window).on("resize", function() {
        if(timer_id != undefined) {
            clearTimeout(timer_id);
            timer_id = undefined;
        }
        timer_id = setTimeout(function() {
            timer_id = undefined;
            callback();
        }, timeout);
    });
}

function resize_callback() {
    forceRedrawPlanetarium();
}
setResizeHandler(resize_callback, 200);


function goFullscreen(elem) {
    if(fullscreen) {
        closeFullscreen();
    } else {
        openFullscreen(elem);
    }
}

function openFullscreen(elem) {
    if (elem.requestFullscreen) {
        elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
    }

    fullscreen = true;
}

function closeFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) { /* Safari */
        document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { /* IE11 */
        document.msExitFullscreen();
    }

    fullscreen = false;
}


$( document ).ready(function() {
    $('#latest-image').on("click", function() {
        goFullscreen(this);
    });

    init();
});


(() => {
  const btn = document.getElementById('download');
  let inProgress = false;

  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopImmediatePropagation();
    if (inProgress) return;
    inProgress = true;
    btn.disabled = true;

    try {
      const el = document.getElementById('wrapper');
      if (!el) throw new Error('#wrapper not found');

      if (document.fonts) await document.fonts.ready;

      const canvas = await html2canvas(el, {
        backgroundColor: null,
        scale: 1,
        useCORS: true
      });

      canvas.toBlob(blob => {
        if (!blob) return;

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'virtualsky_' + Math.floor(Date.now() / 1000) + '.png';
        a.target = '_self';

        document.body.appendChild(a);
        a.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

        setTimeout(() => {
          a.remove();
          URL.revokeObjectURL(url);
        }, 1500);
      }, 'image/png');

    } finally {
      setTimeout(() => {
        inProgress = false;
        btn.disabled = false;
      }, 1000);
    }
  }, { capture: true, passive: false });
})();

</script>
{% endblock %}
