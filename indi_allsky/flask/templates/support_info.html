{% extends 'base.html' %}

{% block title %}indi-allsky: Support Info{% endblock %}

{% block head %}
<meta charset="UTF-8">
<style>
pre {
    white-space: pre-wrap;
}
</style>
<script type="text/javascript" src="{{ url_for('indi_allsky.static', filename='js/clipboard.min.js') }}"></script>
<script type="text/javascript">
var camera_id = {{ camera_id }};
</script>

{% endblock %}

{% block content %}
<div class="row">
    <div class="col-sm-2">
        <span class="badge pill bg-primary copy-clipboard" style="cursor: pointer;" data-clipboard-target="#support_info">Copy Support Info to Clipboard</span>
    </div>
    <div class="col-sm-2">
        <span id="dl_support" class="badge pill bg-info text-dark" style="cursor: pointer;">Support Info<br>Download</span>
    </div>
    <div class="col-sm-2">
        <a href="https://github.com/aaronwmorris/indi-allsky/issues" class="text-decoration-none link-info" target="_blank">
            <span class="badge pill bg-danger">indi-allsky<br>GitHub Issues</span>
        </a>
    </div>
    <div class="col-sm-1">
        <a href="{{ url_for('indi_allsky.log_download_view') }}"><span class="badge pill bg-success">Capture Log<br>Download</span></a>
    </div>
    <div class="col-sm-1">
        <a href="{{ url_for('indi_allsky.log_webapp_download_view') }}"><span class="badge pill bg-secondary">Webapp Log<br>Download</span></a>
    </div>
    <div class="col-sm-1">
    </div>
    <div class="col-sm-1">
      <div id="loader_support" class="spinner-border text-info" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
</div>

<hr>

<div class="row">
    <div class="col-sm-6">
    </div>
    <div class="col-sm-1">
        <a href="{{ url_for('indi_allsky.log_syslog_download_view') }}"><span class="badge pill bg-primary">OS System Log<br>Download</span></a>
    </div>
    <div class="col-sm-1">
        <a href="{{ url_for('indi_allsky.log_kern_download_view') }}"><span class="badge pill bg-warning text-dark">Kernel Log<br>Download</span></a>
    </div>
</div>


<hr>
Support info can be pasted directly into an issue
<hr>

<div class="row">
    <div class="col-sm-12">
      <pre>
        <textarea id="support_info" rows="35" style="width:95%;background-color:#888888;">Loading...</textarea>
      </pre>
    </div>
</div>

<script>

function loadSupportInfo() {
    console.log('Loading support info');
    loadJS("{{ url_for('indi_allsky.js_support_info_view') }}");
}


function loadJS(url, onDone, onError) {
    if(!onDone)onDone=function(){};
    if(!onError)onError=function(){};

    $.ajax({
        type: "GET",
        url: url,
        contentType: "application/json",
        data: {},
        success: function(json_data){
            $("#support_info").text(json_data['support_info']);
            $("#loader_support").css({'display' : 'none'});

            // add download action
            $('#dl_support').on('click', saveTextAsFile);
        },
        error: function(data){
            onError(data.status);
        },
    });
}


async function createGzipFile(dataString, filename) {
  // Convert the string to a Uint8Array
  const textEncoder = new TextEncoder();
  const dataBytes = textEncoder.encode(dataString);

  // Create a ReadableStream from the data
  const readableStream = new ReadableStream({
    start(controller) {
      controller.enqueue(dataBytes);
      controller.close();
    }
  });

  // Create a CompressionStream for gzip
  const compressionStream = new CompressionStream('gzip');

  // Pipe the data through the compression stream
  const compressedStream = readableStream.pipeThrough(compressionStream);

  // Convert the compressed stream to a Blob
  const compressedBlob = await new Response(compressedStream).blob();

  // Create a download link for the Blob
  const url = URL.createObjectURL(compressedBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url); // Clean up the object URL
}


function saveTextAsFile() {
    var textToWrite = $('#support_info').val();

    var d = new Date(Date.now());
    var year = d.getFullYear();
    var month = '' + (d.getMonth() + 1);
    var day = '' + d.getDate();
    var hour = '' + d.getHours();
    var minute = '' + d.getMinutes();
    var second = '' + d.getSeconds();

    var fileNameToSaveAs = "indi-allsky_support_info_" + year + month + day + "_" + hour + minute + second + ".txt.gz";

    createGzipFile(textToWrite, fileNameToSaveAs);
}


function init() {
    new ClipboardJS('.copy-clipboard');

    loadSupportInfo();
}


$( document ).ready(function() {
    init();
});

</script>


{% endblock %}
