{% extends 'base.html' %}

{% block title %}{{ website_title }}: {{ title }}{% endblock %}

{% block head %}
<meta charset="UTF-8">
<style>
.btn {
	width: 150px;
	height: 50px;
}

#pin-loader {
  display: none;
}
</style>
<script type="text/javascript">
var camera_id = {{ camera_id }};
var gpio_class = "{{ gpio_class}}";
var pin_states = {{ pin_states | tojson }};
</script>
{% endblock %}

{% block content %}
<div class="container h-100">

<hr>

<div class="form-group row">
    <div class="col-sm-12">
        Click the buttons to toggle the pin state
    </div>
</div>

<hr>

<div class="form-group row">
    <div class="col-sm-12">
        <div><span class="badge rounded-pill bg-info text-dark">Note</span> Some pins will read HIGH by default due to the internal pull-up being enabled at boot.  Raspberry Pi GPIOs 1-8 have pull-ups enabled by default.</div>
    </div>
</div>

<hr>

<div class="form-group row">
    <div class="col-sm-12">
        <div><span class="badge rounded-pill bg-warning text-dark">Warning</span> It is not recommended to manually control the Dew Heater and Fan pins here.  If you try, it will result in a locked GPIO which may prevent indi-allsky from managing the devices or an error here.</div>
    </div>
</div>

<hr>

<div class="form-group row">
    <div class="col-sm-2">
      Pin {{ pin_names[0] }}
    </div>
    <div class="col-sm-2">
        <button id="pin-1-button" class="btn btn-dark" disabled="disabled">n/a</button>
    </div>
</div>

<hr>

<div class="form-group row">
    <div class="col-sm-2">
      Pin {{ pin_names[1] }}
    </div>
    <div class="col-sm-2">
        <button id="pin-2-button" class="btn btn-dark" disabled="disabled">n/a</button>
    </div>
</div>

<hr>

<div class="form-group row">
    <div class="col-sm-2">
      Pin {{ pin_names[2] }}
    </div>
    <div class="col-sm-2">
        <button id="pin-3-button" class="btn btn-dark" disabled="disabled">n/a</button>
    </div>
</div>

<hr>

<div class="form-group row">
    <div class="col-sm-2">
        <span id="pin-loader" class="spinner-border" aria-hidden="true"></span>
    </div>
    <div class="col-sm-2">
        <input class="form-check-input" id="PIN_CONFIRM1" name="PIN_CONFIRM1" type="checkbox" value="y"> Confirm
    </div>
</div>

<div class="form-group row">
    <div class="col-sm-5">
        <div id="success-message" class="alert alert-success" role="alert" style="display: none;"></div>
        <div id="failure-message" class="alert alert-danger" role="alert" style="display: none;"></div>
    </div>
</div>

<script>


$('#pin-1-button').on('click', function() {
    togglePin(1, !Boolean(pin_states[0]), 'pin-1-button');
});

$('#pin-2-button').on('click', function() {
    togglePin(2, !Boolean(pin_states[1]), 'pin-2-button');
});

$('#pin-3-button').on('click', function() {
    togglePin(3, !Boolean(pin_states[2]), 'pin-3-button');
});

function togglePin(pin_id, new_pin_state, pin_button) {
    $('#success-message').css({'display' : 'none'});
    $('#failure-message').css({'display' : 'none'});

    if (! $("#PIN_CONFIRM1").prop('checked')) {
        console.log('Confirm checkbox not checked');
        return;
    }
    $("#PIN_CONFIRM1").prop('checked', false);

    $('#pin-loader').css({'display' : 'block'});

    $('#' + pin_button).attr({'disabled' : 'disabled'});


    var json_data = {
        'PIN_ID' : pin_id,
        'NEW_PIN_STATE' : new_pin_state,
    };


    $.ajax({
        type: "POST",
        url: "{{ url_for('indi_allsky.ajax_manual_gpio_view') }}",
        contentType: "application/json",
        data: JSON.stringify(json_data),
        success: function(rdata){
            $('#pin-loader').css({'display' : 'none'});
            $('#' + pin_button).removeAttr('disabled');


            if (rdata['pin_state']) {
                $('#' + pin_button).removeClass('btn-success btn-danger');
                $('#' + pin_button).addClass('btn-success');
                $('#' + pin_button).text('On');
            } else {
                $('#' + pin_button).removeClass('btn-success btn-danger');
                $('#' + pin_button).addClass('btn-danger');
                $('#' + pin_button).text('Off');
            }

            // update states
            pin_states[pin_id - 1] = Number(rdata['pin_state']);


            $('#success-message').html(rdata['success-message']);
            $('#success-message').css({'display' : 'block'});
            setTimeout(function() {
                $('#success-message').css({'display' : 'none'});
            }, 15000);
        },
        error: function(rdata){
            $('#pin-loader').css({'display' : 'none'});

            var errors = JSON.parse(rdata.responseText);

            $('#' + pin_button).removeAttr('disabled');
            $('#failure-message').html(errors['failure-message']);
            $('#failure-message').css({'display' : 'block'});
        },
    });
}


function init() {
    $("#PIN_CONFIRM1").prop('checked', false);

    if (gpio_class) {
        if (pin_states[0] != -1) {
            if (pin_states[0]) {
                $('#pin-1-button').addClass('btn-success');
                $('#pin-1-button').text('On');
            } else {
                $('#pin-1-button').addClass('btn-danger');
                $('#pin-1-button').text('Off');
            }

            $('#pin-1-button').removeClass('btn-dark');
            $('#pin-1-button').removeAttr('disabled');
        } else {
            $('#pin-1-button').text('Error');
            $('#pin-1-button').attr({'disabled' : 'disabled'});
        }


        if (pin_states[1] != -1) {
            if (pin_states[1]) {
                $('#pin-2-button').addClass('btn-success');
                $('#pin-2-button').text('On');
            } else {
                $('#pin-2-button').addClass('btn-danger');
                $('#pin-2-button').text('Off');
            }

            $('#pin-2-button').removeClass('btn-dark');
            $('#pin-2-button').removeAttr('disabled');
        } else {
            $('#pin-2-button').text('Error');
            $('#pin-2-button').attr({'disabled' : 'disabled'});
        }


        if (pin_states[2] != -1) {
            if (pin_states[2]) {
                $('#pin-3-button').addClass('btn-success');
                $('#pin-3-button').text('On');
            } else {
                $('#pin-3-button').addClass('btn-danger');
                $('#pin-3-button').text('Off');
            }

            $('#pin-3-button').removeClass('btn-dark');
            $('#pin-3-button').removeAttr('disabled');
        } else {
            $('#pin-3-button').text('Error');
            $('#pin-3-button').attr({'disabled' : 'disabled'});
        }
    }
}


$( document ).ready(function() {
    init();
});
</script>


{% endblock %}
